#!/usr/bin/env node
/* eslint-disable no-console */
const fs = require('fs');
const path = require('path');

const DEFAULT_ATTRIBUTIONS = path.join('assets', 'ATTRIBUTIONS.json');
const DEFAULT_OUTPUT_DIR = path.join('assets', 'monuments');
const DEFAULT_MODULE_FILE = path.join(DEFAULT_OUTPUT_DIR, 'index.js');

function formatJsValue(value) {
  if (value === undefined) {
    return 'null';
  }
  return JSON.stringify(value ?? null);
}

function ensureFileExists(filePath) {
  if (!fs.existsSync(filePath)) {
    throw new Error(`File not found: ${filePath}`);
  }
}

function buildModule(attributions, outputDir, moduleFile) {
  const lines = [];
  lines.push('// Auto-generated by scripts/build-monument-manifest.js');
  lines.push('// Do not edit manually.');
  lines.push('export const monumentImages = {');

  const slugs = Object.keys(attributions || {}).sort();
  for (const slug of slugs) {
    const entries = Array.isArray(attributions[slug]) ? attributions[slug] : [];
    if (!entries.length) continue;

    const validEntries = entries
      .map((entry) => {
        if (!entry.filename) {
          return null;
        }
        const filePath = path.join(outputDir, slug, entry.filename);
        if (!fs.existsSync(filePath)) {
          return null;
        }
        return {
          entry,
          requirePath: `./${slug}/${entry.filename}`.replace(/\\/g, '/'),
        };
      })
      .filter(Boolean);

    if (!validEntries.length) continue;

    lines.push(`  "${slug}": [`);
    for (const { entry, requirePath } of validEntries) {
      lines.push('    {');
      lines.push(`      title: ${formatJsValue(entry.title)},`);
      lines.push(`      filename: ${formatJsValue(entry.filename)},`);
      lines.push(`      url: ${formatJsValue(entry.url)},`);
      lines.push(`      localPath: ${formatJsValue(entry.localPath)},`);
      lines.push(`      width: ${formatJsValue(entry.width)},`);
      lines.push(`      height: ${formatJsValue(entry.height)},`);
      lines.push(`      author: ${formatJsValue(entry.author)},`);
      lines.push(`      credit: ${formatJsValue(entry.credit)},`);
      lines.push(`      license: ${formatJsValue(entry.license)},`);
      lines.push(`      licenseUrl: ${formatJsValue(entry.licenseUrl)},`);
      lines.push(`      source: ${formatJsValue(entry.source)},`);
      lines.push(`      retrievedAt: ${formatJsValue(entry.retrievedAt)},`);
      lines.push(`      image: require('${requirePath}'),`);
      lines.push('    },');
    }
    lines.push('  ],');
  }

  lines.push('};');
  lines.push('export default monumentImages;');
  fs.writeFileSync(moduleFile, `${lines.join('\n')}\n`, 'utf8');
}

(function main() {
  const cwd = process.cwd();
  const attribPath = path.resolve(cwd, DEFAULT_ATTRIBUTIONS);
  const outputDir = path.resolve(cwd, DEFAULT_OUTPUT_DIR);
  const moduleFile = path.resolve(cwd, DEFAULT_MODULE_FILE);

  ensureFileExists(attribPath);
  ensureFileExists(outputDir);

  const attributions = JSON.parse(fs.readFileSync(attribPath, 'utf8'));
  buildModule(attributions, outputDir, moduleFile);

  console.log(`Manifest generado en ${path.relative(cwd, moduleFile)}`);
})();
